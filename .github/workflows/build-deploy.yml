name: Build and Deploy All Dashboards

on:
  # Scheduled builds from 1 AM to 6 AM UTC
  schedule:
    - cron: '0 1-6 * * *'  # Every hour from 1 AM to 6 AM UTC
  
  # Manual trigger
  workflow_dispatch:
  
  # Push to master branch
  push:
    branches:
      - master

permissions:
  contents: write
  pages: write
  id-token: write

env:
  # Unified environment variables for all jobs
  NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
  ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
  FINNHUB_KEY: ${{ secrets.FINNHUB_KEY }}
  FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
  COINMARKETCAP_KEY: ${{ secrets.COINMARKETCAP_KEY }}
  COINGECKO_KEY: ${{ secrets.COINGECKO_KEY }}
  OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
  ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_KEY }}
  GIGA_AI_KEY: ${{ secrets.GIGA_AI_KEY }}
  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
  MACRO_KEY: ${{ secrets.MACRO_KEY }}
  WORLD_BANK_KEY: ${{ secrets.WORLD_BANK_KEY }}
  POLYGON_KEY: ${{ secrets.POLYGON_KEY }}
  TWELVE_DATA_KEY: ${{ secrets.TWELVE_DATA_KEY }}

jobs:
  # =========================================
  # STEP 1: Unified Data Fetch (runs ONCE)
  # =========================================
  fetch-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          pip install requests yfinance feedparser pandas numpy
      
      - name: Run Unified Data Fetcher
        run: |
          python tools/fetchers/unified_fetcher.py --all
      
      - name: Upload Fetched Data
        uses: actions/upload-artifact@v4
        with:
          name: fetched-data
          path: data/
          retention-days: 1

  # =========================================
  # STEP 2: Build All Apps (parallel matrix)
  # =========================================
  build:
    needs: fetch-data
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        app:
          - the-shield
          - the-frontier
          - the-map
          - the-coin
          - the-strategy
          - the-library
          - the-commander
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Fetched Data
        uses: actions/download-artifact@v4
        with:
          name: fetched-data
          path: data/
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      
      - name: Build ${{ matrix.app }}
        run: |
          npm run build:${{ matrix.app }}
      
      - name: Copy Data to Build Output
        run: |
          # Copy app-specific data to build output if it exists in data/ folder
          if [ -d "data/${{ matrix.app }}" ]; then
            mkdir -p dist/apps/${{ matrix.app }}/data
            cp -r data/${{ matrix.app }}/* dist/apps/${{ matrix.app }}/data/ || true
            # Also copy latest.json to root for easier access
            if [ -f "data/${{ matrix.app }}/latest.json" ]; then
              cp data/${{ matrix.app }}/latest.json dist/apps/${{ matrix.app }}/ || true
            fi
          fi
          
          echo "ðŸ“‚ Contents of dist/apps/${{ matrix.app }}:"
          ls -la dist/apps/${{ matrix.app }}/ || true
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}
          path: dist/apps/${{ matrix.app }}
          retention-days: 1

  # =========================================
  # STEP 3: Deploy to GitHub Pages
  # =========================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download All Build Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/apps
      
      - name: Download Fetched Data
        uses: actions/download-artifact@v4
        with:
          name: fetched-data
          path: dist/apps/data
      
      - name: Prepare Deploy Directory
        run: |
          # Move each app to its correct location (artifacts are nested)
          for app in the-shield the-frontier the-map the-coin the-strategy the-library the-commander; do
            if [ -d "dist/apps/$app/$app" ]; then
              # Artifact downloaded with extra nesting, fix it
              mv dist/apps/$app/$app/* dist/apps/$app/ 2>/dev/null || true
              rmdir dist/apps/$app/$app 2>/dev/null || true
            fi
            
            # Copy shared data to each app for relative path access
            if [ -d "dist/apps/data/$app" ]; then
              mkdir -p dist/apps/$app/data
              cp -r dist/apps/data/$app/* dist/apps/$app/data/ || true
            fi
          done
          
          # Create index.html redirect to dashboard-orchestrator (hub)
          cat > dist/apps/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="0; url=the-commander/">
            <title>Monorepo Dashboards</title>
          </head>
          <body>
            <p>Redirecting to <a href="the-commander/">Dashboard Hub</a>...</p>
          </body>
          </html>
          EOF
          
          # List what we're deploying
          echo "ðŸ“¦ Deploying the following apps:"
          ls -la dist/apps/
          echo ""
          echo "ðŸ“‚ Data directory contents:"
          ls -la dist/apps/data/ || echo "No shared data directory"
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist/apps
