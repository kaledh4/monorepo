<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description"
        content="AI-powered crypto market intelligence with Hyper Analytical analysis. Real-time risk metrics, macro indicators, and actionable insights.">
    <meta name="keywords"
        content="Bitcoin, Ethereum, Crypto, Market Analysis, Risk Metric, Bull Market Support Band, DXY, Federal Reserve">
    <meta name="author" content="Hyper Analytical">
    <meta name="theme-color" content="#3b82f6">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Hyper Analytical - Crypto Macro Intelligence">
    <meta property="og:description" content="Daily AI-powered crypto market analysis with actionable insights">
    <meta property="og:type" content="website">
    <meta property="og:image" content="./icons/icon-512.png">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./icons/icon-192.png">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="./styles.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <title>The Coin - Crypto Momentum Scanner</title>

    <!-- Plotly for charts -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>

    <!-- Marked for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
    <!-- Install Prompt for PWA -->
    <div id="installPrompt" class="install-prompt">
        <div class="install-prompt-text">
            <div class="install-prompt-title">üì± Install The Coin</div>
            <div class="install-prompt-description">Get instant access to market intelligence</div>
        </div>
        <button class="btn" id="installBtn">Install</button>
        <button class="btn" id="dismissBtn"
            style="background: transparent; border: 1px solid var(--border-color);">Later</button>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-top" style="display: flex; justify-content: space-between; align-items: center;">
                <h1>ü™ô THE COIN</h1>
                <button id="header-install-btn" class="btn"
                    style="display: none; padding: 0.5rem 1rem; font-size: 0.8rem;">Install App</button>
            </div>
            <p class="header-subtitle">Crypto Momentum Scanner</p>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </header>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <div class="loading-text">Analyzing market data & calculating regression bands...</div>
        </div>

        <!-- Main Content (Hidden until data loads) -->
        <div id="mainContent" class="hidden">
            <!-- Risk Metric Section -->
            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚ö†Ô∏è Bitcoin Risk Metric <span
                                class="confidence-score high-confidence">High</span></h3>
                    </div>
                    <div id="riskGauge" style="height: 280px;"></div>
                    <div class="risk-labels">
                        <span>üü¢ Accumulation</span>
                        <span>üü° Neutral</span>
                        <span>üî¥ Distribution</span>
                    </div>
                    <p class="text-muted text-center mt-md" style="font-size: 0.875rem; font-style: italic;">
                        Data-driven insights for informed decisions
                    </p>
                </div>

                <!-- Market Structure -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìà Market Structure <span
                                class="confidence-score high-confidence">High</span></h3>
                    </div>

                    <div class="text-center mb-lg">
                        <div class="metric-label">Bitcoin Price <span
                                class="confidence-score high-confidence">High</span></div>
                        <div class="big-number" id="btcPrice">$--,---</div>
                        <div id="bmsbStatus" class="badge badge-neutral">Loading...</div>
                    </div>

                    <div class="metric-row">
                        <span class="metric-label">20-Week SMA <span
                                class="confidence-score medium-confidence">Medium</span></span>
                        <span class="metric-value text-green" id="sma20">$--,---</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">21-Week EMA <span
                                class="confidence-score medium-confidence">Medium</span></span>
                        <span class="metric-value text-blue" id="ema21">$--,---</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">ETH/BTC Ratio <span
                                class="confidence-score high-confidence">High</span></span>
                        <span class="metric-value" id="ethBtc">0.-----</span>
                    </div>
                </div>
            </div>

            <!-- Macro Indicators -->
            <div class="card full-width">
                <div class="card-header">
                    <h3 class="card-title">üåç Macro Headwinds (Fed & DXY) <span
                            class="confidence-score high-confidence">High</span></h3>
                </div>
                <div class="macro-grid">
                    <div class="macro-item">
                        <div class="metric-label">DXY Index <span class="confidence-score high-confidence">High</span>
                        </div>
                        <div class="macro-item-value text-yellow" id="dxyValue">---</div>
                        <small class="text-muted">Dollar Strength</small>
                    </div>
                    <div class="macro-item">
                        <div class="metric-label">Fed Funds Rate <span
                                class="confidence-score high-confidence">High</span></div>
                        <div class="macro-item-value text-red" id="fedRate">-.--</div>
                        <small class="text-muted">Interest Rate</small>
                    </div>
                    <div class="macro-item">
                        <div class="metric-label">Yield Curve <span class="confidence-score high-confidence">High</span>
                        </div>
                        <div class="macro-item-value" id="yieldCurve">-.--</div>
                        <small class="text-muted">10Y - 2Y Spread</small>
                    </div>
                </div>
            </div>

            <!-- AI Analysis -->
            <div class="card full-width" id="analysis">
                <div class="card-header">
                    <h2 class="card-title">ü§ñ Daily Data-Driven Analysis</h2>
                </div>
                <div id="analysisContent" class="analysis-content">
                    <p>Loading AI-powered market commentary...</p>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <p>Powered by Hyper Analytical</p>
                <p>
                    Data sources: Yahoo Finance (yfinance), St. Louis Fed (FRED), OpenRouter AI
                </p>
                <p style="font-size: 0.75rem; margin-top: var(--spacing-md);">
                    Real-time market intelligence at your fingertips üìä
                </p>
            </footer>
        </div>
    </div>

    <!-- App Script -->
    <script>
        // ==========================================
        // Service Worker Registration
        // ==========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => {
                        console.log('‚úÖ Service Worker registered:', reg);

                        // Listen for updates
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('New update available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => console.log('‚ùå Service Worker registration failed:', err));
            });

            // Listen for messages from service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SYNC_UPDATES') {
                    console.log('üîÑ Syncing updates from service worker');
                    loadDashboardData();
                }
            });
        }

        // ==========================================
        // PWA Install Prompt
        // ==========================================
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.remove('show');
                document.getElementById('header-install-btn').style.display = 'none';
            }
        });

        document.getElementById('dismissBtn').addEventListener('click', () => {
            document.getElementById('installPrompt').classList.remove('show');
        });

        // Manual Header Button Logic
        const headerInstallBtn = document.getElementById('header-install-btn');

        // Update the beforeinstallprompt handler to also show header button
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
            headerInstallBtn.style.display = 'block';
        });

        headerInstallBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.remove('show');
                headerInstallBtn.style.display = 'none';
            }
        });

        window.addEventListener('appinstalled', () => {
            headerInstallBtn.style.display = 'none';
            document.getElementById('installPrompt').classList.remove('show');
            deferredPrompt = null;
        });

        // ==========================================
        // Data Loading & Rendering
        // ==========================================
        async function loadDashboardData() {
            // Try multiple data paths for flexibility
            const dataPaths = [
                './dashboard_data.json',
                './data/latest.json',
                '../data/the-coin/latest.json'
            ];

            let data = null;
            for (const dataPath of dataPaths) {
                try {
                    const response = await fetch(dataPath);
                    if (response.ok) {
                        data = await response.json();
                        console.log(`Data loaded from: ${dataPath}`);
                        break;
                    }
                } catch (e) {
                    console.debug(`Path ${dataPath} failed, trying next...`);
                }
            }

            if (!data) {
                throw new Error('Could not load data from any path');
            }
            try {
                // Hide loading, show content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

                // Update timestamp
                document.getElementById('lastUpdated').textContent = `Updated: ${data.date}`;

                // Update Bitcoin Price
                const btcPrice = data.btc_price;
                document.getElementById('btcPrice').textContent = `$${btcPrice.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;

                // Update BMSB
                document.getElementById('sma20').textContent = `$${data.bmsb.sma_20.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
                document.getElementById('ema21').textContent = `$${data.bmsb.ema_21.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;

                // ETH/BTC Ratio
                document.getElementById('ethBtc').textContent = (data.eth_btc || 0.03500).toFixed(5);

                // BMSB Status Badge
                const bandTop = Math.max(data.bmsb.sma_20, data.bmsb.ema_21);
                const bandBot = Math.min(data.bmsb.sma_20, data.bmsb.ema_21);
                const statusBadge = document.getElementById('bmsbStatus');

                if (btcPrice > bandTop) {
                    statusBadge.textContent = 'üü¢ Above Support Band';
                    statusBadge.className = 'badge badge-bullish';
                } else if (btcPrice < bandBot) {
                    statusBadge.textContent = 'üî¥ Below Support Band';
                    statusBadge.className = 'badge badge-bearish';
                } else {
                    statusBadge.textContent = 'üü° Inside Support Band';
                    statusBadge.className = 'badge badge-neutral';
                }

                // Macro Indicators
                document.getElementById('dxyValue').textContent = (data.macro.dxy || 104.5).toFixed(2);
                document.getElementById('fedRate').textContent = `${(data.macro.fed_rate || 5.25).toFixed(2)}%`;

                const yieldCurve = data.macro.yield_inversion || -0.35;
                const yieldEl = document.getElementById('yieldCurve');
                yieldEl.textContent = `${yieldCurve.toFixed(2)}%`;
                yieldEl.style.color = yieldCurve < 0 ? 'var(--accent-red)' : 'var(--accent-green)';

                // Render Risk Gauge
                renderRiskGauge(data.risk_metric.current);

                // Display standardized risk metrics if available
                if (data.risk_metric.standardized && Object.keys(data.risk_metric.standardized).length > 0) {
                    const standardizedMetrics = data.risk_metric.standardized;
                    const metricsHtml = `
                        <div class="metric-info">
                            <strong>Standardized Risk Assessment:</strong><br>
                            Composite Risk: ${standardizedMetrics.composite_risk}<br>
                            Confidence: ${standardizedMetrics.overall_confidence}<br>
                            ${standardizedMetrics.composite_interpretation}
                        </div>
                    `;
                    // Add this information to the risk gauge container
                    const riskContainer = document.querySelector('#riskGauge').parentElement;
                    if (!document.querySelector('.metric-info')) {
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'metric-info';
                        infoDiv.innerHTML = metricsHtml;
                        riskContainer.appendChild(infoDiv);
                    }
                }

                // Render Analysis
                const analysisHTML = marked.parse(data.commentary || '**Analysis coming soon...**');
                document.getElementById('analysisContent').innerHTML = analysisHTML;

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="loading-text" style="color: var(--accent-red);">
                        ‚ùå Error loading data. Please check back later or run the GitHub Action manually.
                    </div>
                `;
            }
        }

        // ==========================================
        // Risk Gauge Rendering (Plotly)
        // ==========================================
        function renderRiskGauge(riskValue) {
            const gaugeData = [{
                type: "indicator",
                mode: "gauge+number+delta",
                value: riskValue,
                number: {
                    font: { size: 48, color: "#e4e6eb" },
                    suffix: ""
                },
                delta: {
                    reference: 0.5,
                    increasing: { color: "#ef4444" },
                    decreasing: { color: "#10b981" }
                },
                gauge: {
                    axis: {
                        range: [0, 1],
                        tickwidth: 2,
                        tickcolor: "#6b7280",
                        tickfont: { color: "#b8bcc8" }
                    },
                    bar: { color: "#3b82f6", thickness: 0.3 },
                    bgcolor: "#141922",
                    borderwidth: 2,
                    bordercolor: "#2d3748",
                    steps: [
                        { range: [0, 0.4], color: "rgba(16, 185, 129, 0.3)" },
                        { range: [0.4, 0.7], color: "rgba(245, 158, 11, 0.3)" },
                        { range: [0.7, 1.0], color: "rgba(239, 68, 68, 0.3)" }
                    ],
                    threshold: {
                        line: { color: "#ffffff", width: 4 },
                        thickness: 0.75,
                        value: riskValue
                    }
                }
            }];

            const layout = {
                height: 280,
                margin: { t: 20, r: 20, l: 20, b: 20 },
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(0,0,0,0)",
                font: {
                    color: "#b8bcc8",
                    family: "Inter, sans-serif"
                }
            };

            const config = {
                displayModeBar: false,
                responsive: true
            };

            Plotly.newPlot('riskGauge', gaugeData, layout, config);
        }

        // ==========================================
        // Initialize App
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();

            // Auto-refresh every 5 minutes
            setInterval(loadDashboardData, 5 * 60 * 1000);
        });
    </script>
</body>

</html>